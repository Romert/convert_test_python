#!/bin/bash

# –¶–≤–µ—Ç–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;36m'
NC='\033[0m'

echo -e "${GREEN}üîç –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ –∏ –ø–∞–ø–∫–∞–º–∏ (–ø–æ –¥–Ω—è–º)${NC}"
echo

# 1. –ö–∞—Ç–∞–ª–æ–≥ –ø–æ–∏—Å–∫–∞
while true; do
    read -p "üìÅ –í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ –∫–∞—Ç–∞–ª–æ–≥—É –¥–ª—è –ø–æ–∏—Å–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: —Ç–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è): " target_dir
    target_dir="${target_dir:-.}"
    if [ -d "$target_dir" ]; then
        echo -e "${GREEN}‚úÖ –ö–∞—Ç–∞–ª–æ–≥ '$target_dir' –Ω–∞–π–¥–µ–Ω.${NC}"
        break
    else
        echo -e "${RED}‚ùå –ö–∞—Ç–∞–ª–æ–≥ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.${NC}"
    fi
done

# 2. –¢–∏–ø –æ–±—ä–µ–∫—Ç–æ–≤
echo
echo "üîé –ß—Ç–æ –∏—Å–∫–∞—Ç—å?"
select choice in "–¢–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã" "–¢–æ–ª—å–∫–æ –ø–∞–ø–∫–∏" "–§–∞–π–ª—ã –∏ –ø–∞–ø–∫–∏"; do
    case $REPLY in
        1) type_flag="-type f"; break ;;
        2) type_flag="-type d"; break ;;
        3) type_flag=""; break ;;
        *) echo -e "${RED}–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ.${NC}" ;;
    esac
done

# 3. –í–æ–∑—Ä–∞—Å—Ç –≤ –¥–Ω—è—Ö
echo
read -p "üìÖ –í–≤–µ–¥–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç –≤ –¥–Ω—è—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 60): " days
days="${days:-60}"

if ! [[ "$days" =~ ^[0-9]+$ ]] || [ "$days" -lt 0 ]; then
    echo -e "${RED}‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ. –ò—Å–ø–æ–ª—å–∑—É–µ–º 60 –¥–Ω–µ–π.${NC}"
    days=60
fi

# 4. –ü–æ–∏—Å–∫
echo -e "${YELLOW}–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–æ–≤, –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –±–æ–ª–µ–µ $days –¥–Ω–µ–π –Ω–∞–∑–∞–¥...${NC}"
results_file=$(mktemp -t old_files.XXXXXX)
find "$target_dir" $type_flag -mtime +$days > "$results_file"

if [ ! -s "$results_file" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.${NC}"
    rm -f "$results_file"
    exit 0
fi

count=$(wc -l < "$results_file")
echo -e "${GREEN}‚úÖ –ù–∞–π–¥–µ–Ω–æ $count –æ–±—ä–µ–∫—Ç–æ–≤.${NC}"

# 5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫?
echo
read -p "üìÑ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ —Ñ–∞–π–ª? (y/n, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: y): " save_list
save_list="${save_list:-y}"
if [[ "$save_list" =~ ^[Yy]$ ]]; then
    default_list="old_files_$(date +%Y%m%d_%H%M%S).txt"
    read -p "   –ò–º—è —Ñ–∞–π–ª–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: $default_list): " list_name
    list_name="${list_name:-$default_list}"
    cp "$results_file" "$list_name"
    echo -e "${GREEN}‚úÖ –°–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω: $list_name${NC}"
fi

# 6. –î–µ–π—Å—Ç–≤–∏–µ
echo
echo "üõ†Ô∏è –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏?"
echo "1) –ù–∏—á–µ–≥–æ (—Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑–∞—Ç—å)"
echo "2) –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤ .tar.gz"
echo "3) –£–¥–∞–ª–∏—Ç—å (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!)"
while true; do
    read -p "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ (1/2/3): " action
    case $action in
        1)
            echo -e "${BLUE}‚ÑπÔ∏è –ù–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ.${NC}"
            break
            ;;
        2)
            default_arc="old_archive_$(date +%Y%m%d_%H%M%S).tar.gz"
            read -p "   –ò–º—è –∞—Ä—Ö–∏–≤–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: $default_arc): " arc_name
            arc_name="${arc_name:-$default_arc}"

            echo -e "${YELLOW}–°–æ–∑–¥–∞—ë—Ç—Å—è –∞—Ä—Ö–∏–≤...${NC}"
            if tar -czf "$arc_name" -T "$results_file" 2>/dev/null; then
                echo -e "${GREEN}‚úÖ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: $arc_name${NC}"
            else
                echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞—Ä—Ö–∏–≤–∞. –í–æ–∑–º–æ–∂–Ω–æ, —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ñ–∞–π–ª–æ–≤ –∏–ª–∏ –Ω–µ—Ç –ø—Ä–∞–≤.${NC}"
            fi
            break
            ;;
        3)
            # === –£–õ–£–ß–®–ï–ù–ù–û–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –£–î–ê–õ–ï–ù–ò–Ø ===
            echo
            echo -e "${RED}‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –£–î–ê–õ–ò–¢–¨ $count –æ–±—ä–µ–∫—Ç–æ–≤!${NC}"
            echo -e "${RED}–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û.${NC}"
            
            # –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã (–ø–µ—Ä–≤—ã–µ 5)
            echo -e "${YELLOW}–ü—Ä–∏–º–µ—Ä—ã –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:${NC}"
            head -n 5 "$results_file" | while IFS= read -r line; do
                echo "  ‚Ä¢ $line"
            done
            if [ "$count" -gt 5 ]; then
                echo "  ... –∏ –µ—â—ë $((count - 5)) –æ–±—ä–µ–∫—Ç–æ–≤"
            fi
            echo

            echo -e "${RED}–ß—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ, –≤–≤–µ–¥–∏—Ç–µ –¢–û–ß–ù–û: ${BLUE}YES${NC}"
            read -p "–í–∞—à –≤–≤–æ–¥: " confirm
            if [[ "$confirm" == "YES" ]]; then
                echo -e "${YELLOW}–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —É–¥–∞–ª–µ–Ω–∏–µ...${NC}"
                while IFS= read -r item; do
                    if [ -e "$item" ]; then
                        rm -rf "$item"
                    fi
                done < "$results_file"
                echo -e "${GREEN}‚úÖ –£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ $count –æ–±—ä–µ–∫—Ç–æ–≤.${NC}"
            else
                echo -e "${BLUE}‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ. –ù–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–æ.${NC}"
            fi
            break
            ;;
        *)
            echo -e "${RED}–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –í–≤–µ–¥–∏—Ç–µ 1, 2 –∏–ª–∏ 3.${NC}"
            ;;
    esac
done

# –û—á–∏—Å—Ç–∫–∞
rm -f "$results_file"

echo
echo -e "${GREEN}–ì–æ—Ç–æ–≤–æ!${NC}"
